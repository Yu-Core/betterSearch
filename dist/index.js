"use strict";var isRealNode=function(e){return 1===e.nodeType&&"none"!=getComputedStyle(e).display&&"svg"!==e.tagName},checkClassName=function(t,e){return t.classList&&!e.filter(function(e){try{return-1<t.className.indexOf(e)}catch(e){return!1}}).length},searchSubStr=function(e,t){for(var r=[],a=e.indexOf(t);-1<a;)r.push(a),a=e.indexOf(t,a+1);return r},formatTextNode=function(e){var t=e.parentNode,r=t.childNodes[Array.apply(null,t.childNodes).indexOf(e)-1],a=t.removeChild(e),n=document.createElement("span");return n.appendChild(a),r?(t.appendChild(n),r.after(n)):t.prepend(n),a},regExpescape=function(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}}(),currentSelectClass="__better-search-current-select",markId=0,BetterSearch=function(){function a(e){classCallCheck(this,a),this.domContainer=e.domContainer||null,this.dom=null,this.keyword="",this.blackClassName=e.blackClassName||[],this.searchDom={text:"",data:{}},this.count=0,this.domList=[],this.searchIndex=-1,this.overflowXDom=[],this.overflowYDom=[];var t="."+currentSelectClass+"{background: #FF9632 !important;}",r=document.createElement("style");r.appendChild(document.createTextNode(t)),document.head.appendChild(r)}return createClass(a,[{key:"search",value:function(e){if(this.domContainer&&e){this.clear(),this.keyword=e.trim();var t=document.querySelector(this.domContainer);this.dom=t,this.formatDom(t,this.keyword);for(var r=searchSubStr(this.searchDom.text,this.keyword),a=0;a<r.length;a++){for(var n=r[a],o=r[a]+this.keyword.length-1,s=Object.keys(this.searchDom.data),i=[],h=0;h<s.length;h++){var l=s[h].split("-");if(!(l[1]<n||l[0]>o)){if(l[0]<=n&&l[1]>=o){i.push(this.searchDom.data[s[h]]);break}i.push(this.searchDom.data[s[h]])}}if(i.length<2){var c=i[0];this.markDom(c,this.keyword,!0)}else{var d="",u=this.keyword.length;i.forEach(function(e){d+=e.parentNode.innerText});for(var m=d.indexOf(this.keyword),f=0;f<i.length;f++){var p="";0===f?(u-=(p=i[f].parentNode.innerText.slice(m)).length,this.markDom(i[f],p,!1)):f===i.length-1?(p=i[f].parentNode.innerText.slice(0,u),this.markDom(i[f],p,!1)):(u-=i[f].parentNode.innerText.length,this.markDom(i[f],i[f].parentNode.innerText,!1))}}}this.domList=this.getDomList(),this.count=this.domList.length,this.down()}}},{key:"clear",value:function(){this.count=0,this.searchIndex=-1;var e=document.querySelector(this.domContainer);this.rmMdrkDom(e),this.domList=[],this.searchDom={text:"",data:{}},markId=0}},{key:"down",value:function(){this.searchIndex>this.count||(++this.searchIndex,this.searchIndex>=this.count&&(this.searchIndex=0,this.removeSelectClass(this.domList[this.domList.length-1])),this.resetAllSelectClass(),this.goNode(this.searchIndex))}},{key:"up",value:function(){this.searchIndex<0||(--this.searchIndex,this.searchIndex<0&&(this.searchIndex=this.domList.length-1,this.removeSelectClass(this.domList[0])),this.resetAllSelectClass(),this.goNode(this.searchIndex))}},{key:"resetAllSelectClass",value:function(){var t=this;this.domList.forEach(function(e){t.removeSelectClass(e)})}},{key:"removeSelectClass",value:function(e){e.forEach(function(e){e.classList.remove(currentSelectClass)})}},{key:"goNode",value:function(e){var f=this;this.domList[e].forEach(function(e){var t,r,a=f.getParentNodeList(e),n=e.getBoundingClientRect(),o=null,s=!0,i=!1,h=void 0;try{for(var l,c=a[Symbol.iterator]();!(s=(l=c.next()).done);s=!0){var d=l.value,u=f.overflowYDom.indexOf(d),m=f.overflowXDom.indexOf(d);if(-1<u){o=f.overflowYDom[u];break}if(-1<m){f.overflowXDom[m];break}}}catch(e){i=!0,h=e}finally{try{!s&&c.return&&c.return()}finally{if(i)throw h}}o&&(t=o.getBoundingClientRect(),r=n.top+o.scrollTop-t.top-60,o.scrollTo(0,r||0)),f.addSelectClass([e])})}},{key:"getParentNodeList",value:function(e){var t=[],r=e;for(t.push(e);!r.isEqualNode(this.dom);)t.push(r.parentNode),r=r.parentNode;return t}},{key:"addSelectClass",value:function(e){e.forEach(function(e){e.classList.add(currentSelectClass)})}},{key:"rmMdrkDom",value:function(e){e.querySelectorAll("mark.search-highlight").forEach(function(e){e.parentNode&&e.parentNode.querySelector("template[search-highlight]")&&(e.parentNode.innerHTML=e.parentNode.querySelector("template[search-highlight]").innerHTML)})}},{key:"getDomList",value:function(){var e=document.querySelectorAll("mark.search-highlight"),r={};return e.forEach(function(e){var t=e.getAttribute("mark-id");r[t]||(r[t]=[]),r[t].push(e)}),Object.values(r)}},{key:"markDom",value:function(n,e,o){var t,s,i;n.parentNode&&e&&(1<n.parentNode.childNodes.length&&(n=formatTextNode(n)),t=new RegExp(regExpescape(e),"ig"),(s=n.data.match(t))&&(i=n.data.split(t),n.parentNode.innerHTML=i.reduce(function(e,t,r){var a=e+t+(r<i.length-1?'<mark class="search-highlight" mark-id="'+markId+'">'+s[r]+"</mark>":"<template search-highlight>"+n.data+"</template>");return o&&markId++,a},"")))}},{key:"formatDom",value:function(e,a){var n=this,t=e.childNodes;t.length&&a.length&&t.forEach(function(e){if(1===e.nodeType||3===e.nodeType)if(isRealNode(e)&&(e.scrollHeight>e.clientHeight&&n.overflowYDom.push(e),e.scrollWidth>e.clientWidth&&n.overflowXDom.push(e)),isRealNode(e)&&checkClassName(e,n.blackClassName)&&!/(script|style|template)/i.test(e.tagName))n.formatDom(e,a);else if(3===e.nodeType)for(var t=0;t<a.length;t++)if(-1<e.data.indexOf(a[t])){var r=n.searchDom.text.length;n.searchDom.text=n.searchDom.text+e.parentNode.innerText,n.searchDom.data[r+"-"+(n.searchDom.text.length-1)]=e;break}})}}]),a}();module.exports=BetterSearch;
